<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黃黃家發票系統</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between; 
            align-items: center;
            position: relative; 
        }

        header h1 {
            margin: 0;
            font-size: 1.5em;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #auth-controls {
            z-index: 10;
        }

        /* 確保所有 H2 標題置中 */
        h2 {
            text-align: center;
            margin-top: 0;
        }
        
        /* 新增：將發票對獎中心標題放大置中 */
        h2#center-title {
            font-size: 2.2em; /* 放大字體 */
            font-weight: bold;
            color: #dc3545; /* 給予醒目的顏色 */
            margin-bottom: 25px;
        }
        
        button {
            padding: 15px 25px; 
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 10px;
            white-space: nowrap; 
            transition: background 0.3s;
        }

        button:hover {
            background: #218838;
        }

        .secondary-btn {
            background: #6c757d;
        }

        .secondary-btn:hover {
            background: #5a6268;
        }

        main {
            padding: 25px;
            max-width: 700px; /* 電腦版最大寬度 */
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .page {
            display: none; 
        }

        .page.active {
            display: block; 
        }

        form label {
            display: block; /* 讓 label 獨立佔一行 */
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* 調整全域輸入框和下拉選單大小 */
        form input[type="text"],
        form input[type="password"],
        select { 
            width: 100%; /* 預設佔滿容器 */
            padding: 12px; 
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; 
            font-size: 1em;
            display: block; 
        }
        
        #new-invoice-number {
             width: 50%; /* 登入後的儲存發票輸入框，寬度減半 */
        }
        
        /* ---------------------------------- */
        /* 中獎號碼公告區塊樣式 (顯示號碼的容器) */
        /* ---------------------------------- */
        #winning-numbers-board {
            border: 2px solid #dc3545; /* 強調顏色 */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            background-color: #fff3f3; /* 淺紅色背景 */
        }
        #winning-numbers-board h3 {
             color: #dc3545;
             border-bottom: 2px solid #dc3545;
             padding-bottom: 5px;
             margin-top: 0;
        }
        /* 公告區期別選擇群組 */
        #announcement-term-group {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-bottom: 15px;
        }
        #announcement-term-group label {
             display: inline-block;
             margin: 0;
             flex-shrink: 0;
             font-weight: normal; 
        }
        #winning-term-select-announcement {
             flex-grow: 1;
             width: auto;
             margin: 0;
        }
        
        /* 獎項名稱樣式 */
        .prize-row {
            display: flex;
            margin: 8px 0;
            font-size: 1.1em;
            font-weight: bold;
        }
        .prize-label {
            width: 150px; /* 固定獎項名稱寬度 */
            flex-shrink: 0;
        }
        /* 號碼/佔位符的樣式 */
        .prize-value {
            color: #007bff;
            font-family: monospace;
            font-size: 1.2em;
            font-weight: bold;
            /* 允許換行，解決多組號碼擠在一起的問題 */
            white-space: normal; 
            word-break: break-all;
        }


        /* ---------------------------------- */
        /* 單張對獎區塊的 PC/大螢幕 佈局 */
        /* ---------------------------------- */
        #manual-check-area {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 6px;
            margin-top: 30px;
        }
        
        /* 期別選擇組件 (Label 和 Select 在同一行) */
        #term-select-group {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-top: 15px; 
        }
        #term-select-group label {
            display: inline-block; 
            margin-top: 0;
            margin-bottom: 0;
            flex-shrink: 0;
            width: auto;
        }
        #winning-term-select { 
             flex-grow: 1; 
             width: auto; 
             margin-top: 0;
             margin-bottom: 0;
        }
        
        /* 發票號碼輸入和按鈕 (並排) */
        .input-group {
            display: flex; 
            align-items: stretch; 
            gap: 10px; 
            margin-top: 5px; 
        }
        
        /* 發票號碼輸入框：變大變寬 */
        #invoice-number {
             flex-grow: 1; 
             width: auto; 
             margin-top: 0;
             margin-bottom: 0;
             padding: 15px; 
             font-size: 1.1em;
        }
        
        /* 對獎按鈕：與輸入框對齊 */
        #manual-check-btn {
            flex-shrink: 0;
            margin-top: 0;
            padding: 15px 25px; 
            height: auto; 
        }
        
        /* ---------------------------------- */
        /* 手機響應式調整 (小於 600px 寬度的螢幕) */
        /* ---------------------------------- */
        @media (max-width: 600px) {
            header h1 {
                font-size: 1.2em; /* 標題小一點 */
            }
            main {
                margin: 0; /* 手機上移除左右邊界 */
                padding: 15px;
                max-width: 100%;
                border-radius: 0;
            }

            /* 期別選擇：讓 label 佔一行，select 佔一行 (避免壓縮) */
            #term-select-group, #announcement-term-group {
                display: block;
            }
            #term-select-group label, #announcement-term-group label {
                width: 100%;
                margin-top: 5px;
            }
            #winning-term-select, #winning-term-select-announcement {
                margin-bottom: 5px;
            }

            /* 發票號碼和按鈕：上下垂直排列 (避免壓縮) */
            .input-group {
                display: block; /* 變回垂直排列 */
            }

            #invoice-number {
                width: 100%; /* 佔滿整行 */
                margin-bottom: 10px;
            }

            #manual-check-btn {
                width: 100%; /* 按鈕也佔滿整行 */
                margin-top: 0;
                margin-bottom: 15px;
                padding: 15px 0; /* 垂直填充 */
            }
            
            #new-invoice-number {
                 width: 100%; /* 儲存發票輸入框佔滿整行 */
            }
            
            /* 手機上，獎項名稱不固定寬度 */
            .prize-label {
                width: auto;
                flex-shrink: 1;
            }
        }

        /* ---------------------------------- */
        /* 列表和提示訊息樣式 (不變) */
        /* ---------------------------------- */
        #result-message, #bulk-result-message, #save-message {
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #eee;
        }
        
        #saved-invoices-list {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
        }
        
        #saved-invoices-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            font-weight: bold;
        }
        
        .delete-btn {
            background: none;
            color: red;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 0; 
        }
        .delete-btn:hover {
            color: darkred;
            background: #ffe6e6;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <h1>黃黃家發票系統</h1> 
        <div id="auth-controls">
            <button id="login-btn">登入</button>
        </div>
    </header>

    <main>
        <section id="invoice-section" class="page active">
            <h2 id="center-title">發票對獎公告</h2>
            
            <div id="winning-numbers-board">
                 <h3>中獎號碼公告</h3>
                 
                 <div id="announcement-term-group">
                    <label for="winning-term-select-announcement">請選擇開獎期別：</label>
                     <select id="winning-term-select-announcement" onchange="updateAnnouncementNumbers()">
                        </select>
                 </div>
                 
                 <div class="prize-row">
                     <span class="prize-label">特獎號碼：</span>
                     <span class="prize-value" id="special-prize-number"></span>
                 </div>
                 <div class="prize-row">
                     <span class="prize-label">頭獎號碼：</span>
                     <span class="prize-value" id="first-prize-number"></span>
                 </div>
                 <div class="prize-row">
                     <span class="prize-label">二獎號碼：</span>
                     <span class="prize-value" id="second-prize-number"></span>
                 </div>
                 <div class="prize-row">
                     <span class="prize-label">三獎號碼：</span>
                     <span class="prize-value" id="third-prize-number"></span>
                 </div>
            </div>
            
            <div id="invoice-management" style="display: none;">
                <h3>我的發票管理</h3>
                <label for="new-invoice-number">新增發票號碼 (8碼):</label>
                <input type="text" id="new-invoice-number" maxlength="8" pattern="\d{8}">
                <button onclick="saveInvoice()">儲存發票</button>
                <p id="save-message"></p>

                <hr>
                
                <h4>已儲存發票 (<span id="invoice-count">0</span> 張)</h4>
                <ul id="saved-invoices-list">
                    </ul>
                
                <hr>
                
                <h3>自動對獎</h3>
                <label for="winning-term-select-bulk">請選擇開獎期別:</label>
                 <select id="winning-term-select-bulk">
                    </select>
                <button onclick="checkAllInvoices()" style="background: #dc3545;">自動對獎</button>
                <p id="bulk-result-message" style="font-size: 1.2em;"></p>
            </div>
            
            <div id="manual-check-area">
                 <h3>單張發票對獎</h3>
                 
                 <div id="term-select-group">
                     <label for="winning-term-select">請選擇開獎期別:</label>
                     <select id="winning-term-select">
                        </select>
                 </div>

                <label for="invoice-number">輸入您的發票號碼 (8碼):</label>
                <div class="input-group">
                    <input type="text" id="invoice-number" maxlength="8" pattern="\d{8}" required>
                    <button onclick="checkWinning()" id="manual-check-btn">對獎</button>
                </div>
                 <p id="result-message"></p>
            </div>
        </section>

        <section id="login-section" class="page">
            <h2>使用者登入</h2>
            <form id="login-form">
                <label for="login-username">使用者名稱:</label>
                <input type="text" id="login-username" required>
                
                <label for="login-password">密碼:</label>
                <input type="password" id="login-password" required>
                
                <button type="submit">登入</button>
            </form>
            <button id="show-register-btn" class="secondary-btn">註冊新帳號</button>
        </section>

        <section id="register-section" class="page">
            <h2>新帳號註冊</h2>
            <form id="register-form">
                <label for="reg-username">使用者名稱 (中/英文):</label>
                <input type="text" id="reg-username" required>
                
                <label for="reg-password">密碼 (至少4個字元，英文/數字):</label>
                <input type="password" id="reg-password" minlength="4" required>
                
                <label for="reg-confirm-password">確認密碼:</label>
                <input type="password" id="reg-confirm-password" required>
                
                <button type="submit">註冊</button>
            </form>
            <button id="back-to-login-btn" class="secondary-btn">返回登入</button>
            <p id="register-message" style="color: red;"></p>
        </section>
    </main>

    <script>
        // --- localStorage 鍵名 ---
        const LS_USERS = 'invoiceSystemUsers';
        const LS_INVOICES = 'invoiceSystemInvoices';
        const LS_CURRENT_USER = 'invoiceSystemCurrentUser';
        
        // --- 核心資料庫 (從 localStorage 載入，如果沒有則使用預設值) ---
        
        // 1. 載入使用者資料
        let users;
        try {
             users = JSON.parse(localStorage.getItem(LS_USERS)) || { 'admin': 'Brock_king' };
        } catch (e) {
             console.error("無法解析儲存的使用者資料:", e);
             users = { 'admin': 'Brock_king' };
        }

        // 2. 載入發票資料
        let userInvoices;
        try {
             userInvoices = JSON.parse(localStorage.getItem(LS_INVOICES)) || { 'admin': [] };
        } catch (e) {
             console.error("無法解析儲存的發票資料:", e);
             userInvoices = { 'admin': [] };
        }
        
        // 3. 儲存數據到 localStorage 的通用函數
        function saveUserData() {
             localStorage.setItem(LS_USERS, JSON.stringify(users));
             localStorage.setItem(LS_INVOICES, JSON.stringify(userInvoices));
        }

        // --- 完整的且正確的中獎號碼資料結構 ---
        const allWinningNumbers = {
            '205002': { 
                term: '發票兌換方式', 
                special: '若是中獎', 
                first: ['請聯絡負責人'], 
                second: ['進行兌獎'], 
                third: ['期限為1個月內!']
            },
            '205001': { 
                term: '中獎發票未在期限內兌換處理方式', 
                special: '請先聯絡版主', 
                first: ['依照版主的指示'], 
                second: ['進行處理'], 
                third: ['延期過久無法受理']
            },
             '202603': { 
                term: '115年3月', 
                special: '42658712', 
                first: ['99134721'], 
                second: ['64555912'], 
                third: ['12749456']
            },
             '202602': { 
                term: '115年2月', 
                special: '76147215', 
                first: ['54718236'], 
                second: ['00572216'], 
                third: ['31245768']
            },
             '202601': { 
                term: '115年1月', 
                special: '12447815', 
                first: ['64791567'], 
                second: ['06456104'], 
                third: ['16647201']
            },
        };
        
        // --- 狀態變數 (從 localStorage 載入目前的登入狀態) ---
        let currentUser = localStorage.getItem(LS_CURRENT_USER);
        let isAuthenticated = !!currentUser && users.hasOwnProperty(currentUser);
        
        // --- 頁面元素獲取 (確保 ID 是正確的) ---
        const authControls = document.getElementById('auth-controls');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const invoiceManagement = document.getElementById('invoice-management');
        const savedInvoicesList = document.getElementById('saved-invoices-list');
        const invoiceCountSpan = document.getElementById('invoice-count');
        const newInvoiceInput = document.getElementById('new-invoice-number');
        const saveMessage = document.getElementById('save-message');
        const bulkResultMessage = document.getElementById('bulk-result-message');
        const winningSelectBulk = document.getElementById('winning-term-select-bulk');
        const winningSelectSingle = document.getElementById('winning-term-select'); 
        const winningSelectAnnouncement = document.getElementById('winning-term-select-announcement');
        // 確保這些 ID 都是正確且單純的
        const specialPrizeNum = document.getElementById('special-prize-number');
        const firstPrizeNum = document.getElementById('first-prize-number');
        const secondPrizeNum = document.getElementById('second-prize-number');
        const thirdPrizeNum = document.getElementById('third-prize-number');


        // --- 頁面切換函式 ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // --- 輔助函式：發票對獎核心邏輯 ---
        function isWinning(invNo, winningData) {
            if (!winningData) return false;
            
            // --- 1. 檢查特獎 (8碼完全相符) ---
            if (invNo === winningData.special) return true;
            
            // --- 2. 檢查頭獎 (8碼完全相符) ---
            if (winningData.first && winningData.first.includes(invNo)) return true;

            // --- 3. 檢查二獎 (末七碼相符) ---
            const invLastSeven = invNo.slice(-7);
            const secondWinners = winningData.second || [];
            
            const isSecondWinner = secondWinners.some(secondNo => {
                const secondLastSeven = secondNo.slice(-7);
                return invLastSeven === secondLastSeven;
            });
            if (isSecondWinner) return true;

            // --- 4. 檢查三獎 (末六碼相符) ---
            const invLastSix = invNo.slice(-6);
            const thirdWinners = winningData.third || [];
            
            const isThirdWinner = thirdWinners.some(thirdNo => {
                const thirdLastSix = thirdNo.slice(-6);
                return invLastSix === thirdLastSix;
            });
            if (isThirdWinner) return true;
            
            // --- 5. 檢查末三碼獎 (與所有特、頭、二、三獎的末三碼相符) ---
            const invLastThree = invNo.slice(-3);
            const winningLastThree = [];
            
            // a. 收集所有中獎號碼的末三碼
            // 特獎
            if (winningData.special) {
                winningLastThree.push(winningData.special.slice(-3));
            }
            // 頭獎
            if (winningData.first && winningData.first.length > 0) {
                 winningData.first.map(n => n.slice(-3)).forEach(t => winningLastThree.push(t));
            }
            // 二獎
            if (winningData.second && winningData.second.length > 0) {
                 winningData.second.map(n => n.slice(-3)).forEach(t => winningLastThree.push(t));
            }
            // 三獎
            if (winningData.third && winningData.third.length > 0) {
                 winningData.third.map(n => n.slice(-3)).forEach(t => winningLastThree.push(t));
